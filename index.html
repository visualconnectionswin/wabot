<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Bulk Sender PRO</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 25px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        .grid-item {
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background-color: #fdfdfd;
        }
        h1, h2, h3 {
            color: #2c3e50;
            margin-top: 0;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #1a73e8;
        }
        h2 {
            border-bottom: 2px solid #1a73e8;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        input[type="file"],
        input[type="text"],
        input[type="number"],
        input[type="datetime-local"],
        select,
        textarea {
            width: calc(100% - 22px);
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #1a73e8;
            outline: none;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        button {
            background-color: #1a73e8;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s, box-shadow 0.3s;
            margin-right: 10px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #1558b0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:disabled {
            background-color: #a0c3ff;
            cursor: not-allowed;
        }
        .qr-area, .status-area, .file-info, .process-info, .process-controls, .message-config {
            margin-bottom: 20px;
        }
        #qrCodeImg {
            max-width: 250px;
            height: auto;
            margin: 10px auto;
            display: block;
            border: 1px solid #eee;
            padding: 5px;
            border-radius: 4px;
        }
        #connectionStatus, #progressText, #processStatusText, #overallStatusText {
            font-style: italic;
            color: #555;
            min-height: 1.2em;
        }
        #connectionStatus.connected { color: #27ae60; font-weight: bold; }
        #connectionStatus.disconnected { color: #c0392b; font-weight: bold; }

        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }
        .progress-bar {
            width: 0%;
            height: 25px;
            background-color: #27ae60;
            text-align: center;
            line-height: 25px;
            color: white;
            transition: width 0.4s ease;
        }
        #contactsPreview {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            background-color: #f9f9f9;
            font-size: 0.9em;
            border-radius: 4px;
        }
        #contactsPreview p { margin: 5px 0; }
        .error-message {
            color: #c0392b;
            background-color: #fdd;
            border: 1px solid #c0392b;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .success-message {
            color: #27ae60;
            background-color: #dfd;
            border: 1px solid #27ae60;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ccc;
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1rem;
            margin-right: 5px;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active {
            border-bottom: 3px solid #1a73e8;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #processesList {
            list-style-type: none;
            padding: 0;
        }
        #processesList li {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #processesList li .details { flex-grow: 1; }
        #processesList li .actions button { font-size: 0.8em; padding: 8px 12px; margin-left: 5px; }

        @media (max-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WhatsApp Bulk Sender PRO</h1>

        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'mainTab')">Envío Principal</button>
            <button class="tab-button" onclick="openTab(event, 'statusTab')">Estado del Sistema</button>
            <button class="tab-button" onclick="openTab(event, 'processesTab')">Gestión de Procesos</button>
        </div>

        <div id="mainTab" class="tab-content active">
            <div class="grid-container">
                <div class="grid-item qr-area">
                    <h2>Autenticación WhatsApp</h2>
                    <img id="qrCodeImg" src="" alt="Escanea el código QR">
                    <p id="connectionStatus">Estado de conexión: Desconectado</p>
                    <button id="requestQRButton">Solicitar Nuevo QR (si no aparece)</button>
                </div>

                <div class="grid-item file-upload-area">
                    <h2>1. Cargar Archivo Excel</h2>
                    <form id="uploadForm">
                        <label for="excelFile">Archivo Excel (.xlsx, .xls):</label>
                        <input type="file" id="excelFile" name="excel" accept=".xlsx, .xls" required>
                        <button type="submit" id="uploadButton">Procesar Archivo</button>
                    </form>
                    <div id="fileInfo" style="display: none;">
                        <h3>Información del Archivo:</h3>
                        <p>Filas Totales: <span id="totalRows"></span></p>
                        <p>Contactos Válidos: <span id="validContactsCount"></span></p>
                        <p>Números Totales: <span id="totalNumbers"></span></p>
                        <h4>Vista Previa (primeros 5):</h4>
                        <div id="contactsPreview"></div>
                    </div>
                </div>
            </div>

            <div class="grid-item message-config">
                <h2>2. Configurar Mensaje y Envío</h2>
                <form id="bulkSendForm">
                    <div>
                        <label for="messageTemplate">Plantilla del Mensaje (usa {nombre} para el primer nombre):</label>
                        <textarea id="messageTemplate" rows="5" placeholder="Ej: Hola {nombre}, te recordamos nuestra promoción..."></textarea>
                    </div>
                    <div>
                        <label for="delay">Retraso entre mensajes (milisegundos):</label>
                        <input type="number" id="delay" value="3000" min="1000" max="300000">
                    </div>
                    <div>
                        <label for="mediaUrl">URL del Archivo Multimedia (Opcional):</label>
                        <input type="text" id="mediaUrl" placeholder="https://ejemplo.com/imagen.jpg">
                    </div>
                    <div>
                        <label for="mediaType">Tipo de Multimedia (si URL está presente):</label>
                        <select id="mediaType">
                            <option value="">Ninguno</option>
                            <option value="image">Imagen</option>
                            <option value="video">Video</option>
                            <option value="document">Documento</option>
                            <option value="audio">Audio</option>
                        </select>
                    </div>
                    <div>
                        <label for="scheduledTime">Programar Envío (Opcional):</label>
                        <input type="datetime-local" id="scheduledTime">
                    </div>
                    <button type="submit" id="startBulkSendButton" disabled>Iniciar Envío Masivo</button>
                </form>
            </div>

            <div class="grid-item process-info">
                <h2>Progreso del Envío Actual</h2>
                <p>ID del Proceso: <span id="currentProcessId">-</span></p>
                <p id="processStatusText">Estado: Esperando inicio</p>
                <div class="progress-container">
                    <div id="progressBar" class="progress-bar">0%</div>
                </div>
                <p id="progressText">Enviados: 0/0 | Exitosos: 0 | Fallidos: 0</p>
                <div class="process-controls">
                    <button id="pauseButton" disabled>Pausar</button>
                    <button id="resumeButton" disabled>Reanudar</button>
                    <button id="stopButton" disabled>Detener</button>
                </div>
            </div>
        </div>

        <div id="statusTab" class="tab-content">
            <h2>Estado General del Sistema</h2>
            <button id="refreshOverallStatusButton">Actualizar Estado</button>
            <div id="overallStatusArea">
                <pre id="overallStatusText">Cargando estado...</pre>
            </div>
        </div>
        
        <div id="processesTab" class="tab-content">
            <h2>Gestión de Procesos de Envío</h2>
            <button id="refreshProcessesListButton">Actualizar Lista</button>
            <ul id="processesList">
                <!-- Los procesos se listarán aquí -->
            </ul>
        </div>

        <div id="messageArea"></div>

    </div>

    <script>
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsURL = `${wsProtocol}//${window.location.host}`;
        let ws = null;

        let a_excelContacts = [];
        let a_currentProcessId = null;

        // Elementos UI
        const qrCodeImg = document.getElementById('qrCodeImg');
        const connectionStatusP = document.getElementById('connectionStatus');
        const requestQRButton = document.getElementById('requestQRButton');

        const uploadForm = document.getElementById('uploadForm');
        const excelFile = document.getElementById('excelFile');
        const uploadButton = document.getElementById('uploadButton');
        const fileInfoDiv = document.getElementById('fileInfo');
        const totalRowsSpan = document.getElementById('totalRows');
        const validContactsCountSpan = document.getElementById('validContactsCount');
        const totalNumbersSpan = document.getElementById('totalNumbers');
        const contactsPreviewDiv = document.getElementById('contactsPreview');

        const bulkSendForm = document.getElementById('bulkSendForm');
        const messageTemplateTextarea = document.getElementById('messageTemplate');
        const delayInput = document.getElementById('delay');
        const mediaUrlInput = document.getElementById('mediaUrl');
        const mediaTypeSelect = document.getElementById('mediaType');
        const scheduledTimeInput = document.getElementById('scheduledTime');
        const startBulkSendButton = document.getElementById('startBulkSendButton');

        const currentProcessIdSpan = document.getElementById('currentProcessId');
        const processStatusTextP = document.getElementById('processStatusText');
        const progressBar = document.getElementById('progressBar');
        const progressTextP = document.getElementById('progressText');
        const pauseButton = document.getElementById('pauseButton');
        const resumeButton = document.getElementById('resumeButton');
        const stopButton = document.getElementById('stopButton');

        const messageArea = document.getElementById('messageArea');

        const overallStatusArea = document.getElementById('overallStatusArea');
        const overallStatusText = document.getElementById('overallStatusText');
        const refreshOverallStatusButton = document.getElementById('refreshOverallStatusButton');
        
        const processesListUl = document.getElementById('processesList');
        const refreshProcessesListButton = document.getElementById('refreshProcessesListButton');

        function showMessage(text, type = 'info') {
            const div = document.createElement('div');
            div.textContent = text;
            div.className = type === 'error' ? 'error-message' : (type === 'success' ? 'success-message' : 'info-message');
            messageArea.innerHTML = ''; // Limpiar mensajes anteriores
            messageArea.appendChild(div);
            setTimeout(() => {
                if (messageArea.contains(div)) {
                     messageArea.removeChild(div);
                }
            }, 5000);
        }

        function connectWebSocket() {
            if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
                console.log('WebSocket ya está conectado o conectándose.');
                return;
            }

            ws = new WebSocket(wsURL);

            ws.onopen = () => {
                console.log('WebSocket conectado al servidor.');
                connectionStatusP.textContent = 'Estado de conexión: Conectado al servidor.';
                // Solicitar estado inicial de WhatsApp al conectar
                ws.send(JSON.stringify({ type: 'get_status' }));
                fetchProcesses(); // Cargar procesos al conectar
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    console.log('Mensaje del servidor:', message);

                    switch (message.type) {
                        case 'qr_update':
                            qrCodeImg.src = message.data || '';
                            if (message.data) {
                                connectionStatusP.textContent = 'Estado de conexión: Escanee el QR.';
                                connectionStatusP.className = 'disconnected';
                            } else if (!connectionStatusP.textContent.includes('Autenticado')) {
                                connectionStatusP.textContent = 'Estado de conexión: QR no disponible, esperando autenticación...';
                                connectionStatusP.className = 'disconnected';
                            }
                            break;
                        case 'status_update': // Para estado de conexión WhatsApp
                            if (message.data.connected) {
                                connectionStatusP.textContent = `Estado de conexión: Autenticado como ${message.data.user?.name || message.data.user?.id || 'Usuario'}.`;
                                connectionStatusP.className = 'connected';
                                qrCodeImg.src = ''; // Limpiar QR si está autenticado
                            } else {
                                connectionStatusP.textContent = 'Estado de conexión: WhatsApp Desconectado. Solicitando QR...';
                                connectionStatusP.className = 'disconnected';
                                ws.send(JSON.stringify({ type: 'request_qr' }));
                            }
                            break;
                        case 'process_update':
                            updateProcessUI(message.data);
                            break;
                        default:
                            console.log("Mensaje desconocido del WebSocket:", message);
                    }
                } catch (error) {
                    console.error('Error procesando mensaje WebSocket:', error);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket Error:', error);
                connectionStatusP.textContent = 'Error de conexión WebSocket.';
                connectionStatusP.className = 'disconnected';
                disableAllControls();
            };

            ws.onclose = (event) => {
                console.log('WebSocket desconectado:', event.code, event.reason);
                connectionStatusP.textContent = `Estado de conexión: Desconectado del Servidor (${event.code}).`;
                connectionStatusP.className = 'disconnected';
                disableAllControls();
                // Intentar reconectar después de un tiempo
                setTimeout(connectWebSocket, 5000);
            };
        }
        
        function disableAllControls() {
            uploadButton.disabled = true;
            startBulkSendButton.disabled = true;
            pauseButton.disabled = true;
            resumeButton.disabled = true;
            stopButton.disabled = true;
        }

        requestQRButton.addEventListener('click', () => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'request_qr' }));
                showMessage('Solicitando nuevo QR...', 'info');
            } else {
                showMessage('WebSocket no conectado. Intentando reconectar...', 'error');
                connectWebSocket();
            }
        });

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!excelFile.files.length) {
                showMessage('Por favor, selecciona un archivo Excel.', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('excel', excelFile.files[0]);
            uploadButton.disabled = true;
            uploadButton.textContent = 'Procesando...';

            try {
                const response = await fetch('/api/upload-excel', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.success && result.data) {
                    showMessage('Archivo procesado exitosamente.', 'success');
                    fileInfoDiv.style.display = 'block';
                    totalRowsSpan.textContent = result.data.totalRows;
                    validContactsCountSpan.textContent = result.data.validContacts;
                    totalNumbersSpan.textContent = result.data.summary.totalNumbers;
                    
                    contactsPreviewDiv.innerHTML = ''; // Limpiar vista previa anterior
                    result.data.contacts.forEach(contact => {
                        const p = document.createElement('p');
                        p.textContent = `Nombre: ${contact.name}, Números: ${contact.numbers.join(', ')}, Fila: ${contact.rowIndex}`;
                        contactsPreviewDiv.appendChild(p);
                    });

                    // Guardar todos los contactos, no solo la vista previa
                    const fullContactsResponse = await fetch('/api/upload-excel', { // Re-llamada para obtener todos los contactos
                         method: 'POST',
                         body: formData // Enviar de nuevo el archivo para obtener todos los datos
                    });
                    const fullResult = await fullContactsResponse.json();
                    if (fullResult.success) {
                       a_excelContacts = fullResult.data.contacts; // Actualizar con todos los contactos
                    } else {
                       a_excelContacts = result.data.contacts; // fallback a los de preview
                    }


                    if (a_excelContacts.length > 0) {
                        startBulkSendButton.disabled = false;
                    } else {
                        startBulkSendButton.disabled = true;
                        showMessage('No se encontraron contactos válidos en el archivo.', 'error');
                    }
                } else {
                    showMessage(result.error || 'Error al procesar el archivo.', 'error');
                    startBulkSendButton.disabled = true;
                }
            } catch (error) {
                console.error('Error subiendo archivo:', error);
                showMessage('Error de red al subir el archivo.', 'error');
                startBulkSendButton.disabled = true;
            } finally {
                uploadButton.disabled = false;
                uploadButton.textContent = 'Procesar Archivo';
            }
        });

        bulkSendForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (a_excelContacts.length === 0) {
                showMessage('No hay contactos cargados. Por favor, sube un archivo Excel primero.', 'error');
                return;
            }
            if (!messageTemplateTextarea.value.trim()) {
                showMessage('El mensaje no puede estar vacío.', 'error');
                return;
            }

            const payload = {
                contacts: a_excelContacts,
                messageTemplate: messageTemplateTextarea.value,
                delay: parseInt(delayInput.value, 10),
                mediaUrl: mediaUrlInput.value || undefined,
                mediaType: mediaUrlInput.value ? mediaTypeSelect.value : undefined,
                scheduledTime: scheduledTimeInput.value || undefined
            };

            startBulkSendButton.disabled = true;
            startBulkSendButton.textContent = 'Iniciando...';

            try {
                const response = await fetch('/api/bulk-send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.success) {
                    showMessage(result.message || 'Proceso iniciado/programado.', 'success');
                    a_currentProcessId = result.processId;
                    currentProcessIdSpan.textContent = a_currentProcessId;
                    processStatusTextP.textContent = payload.scheduledTime ? 'Programado' : 'Iniciado';
                    updateProcessSpecificControls(payload.scheduledTime ? 'scheduled' : 'running');
                    // El progreso se actualizará vía WebSocket
                } else {
                    showMessage(result.error || 'Error al iniciar el envío.', 'error');
                    startBulkSendButton.disabled = false; // Permitir reintentar si falla el inicio
                }
            } catch (error) {
                console.error('Error iniciando envío masivo:', error);
                showMessage('Error de red al iniciar el envío.', 'error');
                startBulkSendButton.disabled = false;
            } finally {
                 // No se cambia el texto del botón aquí, se gestiona por estado
            }
        });

        function updateProcessUI(processData) {
            if (!a_currentProcessId || a_currentProcessId === processData.id) { // Actualizar UI principal si es el proceso actual o el único
                a_currentProcessId = processData.id;
                currentProcessIdSpan.textContent = processData.id;
                processStatusTextP.textContent = `Estado: ${processData.status}`;
                
                const progress = processData.progress || 0;
                progressBar.style.width = `${progress}%`;
                progressBar.textContent = `${progress}%`;
                
                progressTextP.textContent = `Enviados: ${processData.currentIndex || 0}/${processData.totalCount || 0} | Exitosos: ${processData.successCount || 0} | Fallidos: ${processData.failureCount || 0}`;
                updateProcessSpecificControls(processData.status);
            }
            // Actualizar la lista de procesos también
            fetchProcesses();
        }

        function updateProcessSpecificControls(status) {
            startBulkSendButton.textContent = 'Iniciar Envío Masivo'; // Reset
            if (status === 'running') {
                pauseButton.disabled = false;
                resumeButton.disabled = true;
                stopButton.disabled = false;
                startBulkSendButton.disabled = true;
            } else if (status === 'paused') {
                pauseButton.disabled = true;
                resumeButton.disabled = false;
                stopButton.disabled = false;
                startBulkSendButton.disabled = true;
            } else if (status === 'scheduled') {
                pauseButton.disabled = true;
                resumeButton.disabled = true;
                stopButton.disabled = false; // Permitir cancelar un programado
                startBulkSendButton.disabled = true;
            } else { // completed, failed, stopped, pending
                pauseButton.disabled = true;
                resumeButton.disabled = true;
                stopButton.disabled = true;
                startBulkSendButton.disabled = (a_excelContacts.length === 0); // Habilitar si hay contactos
                if (status === 'completed' || status === 'stopped' || status === 'failed') {
                    a_currentProcessId = null; // Limpiar para permitir nuevo envío en UI principal
                }
            }
        }
        
        async function controlProcess(id, action) {
            if (!id) {
                showMessage('No hay un proceso activo para controlar.', 'error');
                return;
            }
            try {
                const response = await fetch(`/api/process/${id}/${action}`, { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    showMessage(`Proceso ${id} ${action} exitoso.`, 'success');
                    // La UI se actualizará vía WebSocket 'process_update'
                } else {
                    showMessage(`Error al ${action} el proceso ${id}: ${result.error || 'Error desconocido'}`, 'error');
                }
            } catch (error) {
                console.error(`Error en ${action} proceso:`, error);
                showMessage(`Error de red al ${action} el proceso.`, 'error');
            }
        }

        pauseButton.addEventListener('click', () => controlProcess(a_currentProcessId, 'pause'));
        resumeButton.addEventListener('click', () => controlProcess(a_currentProcessId, 'resume'));
        stopButton.addEventListener('click', () => {
            if (confirm('¿Estás seguro de que quieres detener este proceso?')) {
                controlProcess(a_currentProcessId, 'stop');
            }
        });

        // Tabs
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";

            if (tabName === 'statusTab') fetchOverallStatus();
            if (tabName === 'processesTab') fetchProcesses();
        }

        async function fetchOverallStatus() {
            try {
                overallStatusText.textContent = 'Actualizando...';
                const response = await fetch('/api/status');
                const result = await response.json();
                if (result.success) {
                    overallStatusText.textContent = JSON.stringify(result.data, null, 2);
                } else {
                    overallStatusText.textContent = `Error: ${result.error || 'No se pudo cargar el estado.'}`;
                }
            } catch (error) {
                console.error('Error fetching overall status:', error);
                overallStatusText.textContent = 'Error de red al cargar el estado.';
            }
        }
        refreshOverallStatusButton.addEventListener('click', fetchOverallStatus);

        async function fetchProcesses() {
            try {
                const response = await fetch('/api/processes'); // Asumiendo que este endpoint devuelve lista de procesos, no solo stats.
                                                              // Si solo devuelve stats, necesitarás otro endpoint o modificar este.
                                                              // Por ahora, este endpoint devuelve stats según tu server.js.
                                                              // Para listar procesos individuales con controles, necesitarías un endpoint
                                                              // que devuelva algo como `bulkManager.processes` (un Map convertido a Array).
                                                              // Vamos a simular con las stats por ahora.
                const result = await response.json();
                processesListUl.innerHTML = ''; // Clear list

                if (result.success && result.data) { // result.data son las stats aquí
                    const stats = result.data;
                    for (const statusKey in stats) {
                        if (statusKey !== 'total' && stats[statusKey] > 0) {
                           const li = document.createElement('li');
                           li.textContent = `Procesos ${statusKey}: ${stats[statusKey]}`;
                           processesListUl.appendChild(li);
                        }
                    }
                    if (processesListUl.children.length === 0) {
                         processesListUl.innerHTML = '<li>No hay procesos activos o registrados.</li>';
                    }
                     // Aquí iría la lógica para listar procesos individuales si el endpoint lo soportara
                     // Por ejemplo, si /api/processes devolviera un array de objetos de proceso:
                     /*
                     if (Array.isArray(result.data.list)) { // Suponiendo que result.data.list existe
                        result.data.list.forEach(proc => {
                            const li = document.createElement('li');
                            const detailsDiv = document.createElement('div');
                            detailsDiv.className = 'details';
                            detailsDiv.innerHTML = `
                                <strong>ID:</strong> ${proc.id}<br>
                                <strong>Estado:</strong> ${proc.status}<br>
                                <strong>Progreso:</strong> ${proc.currentIndex || 0}/${proc.totalCount || 0} (${Math.round(((proc.currentIndex || 0) / (proc.totalCount || 1)) * 100)}%)
                            `;
                            const actionsDiv = document.createElement('div');
                            actionsDiv.className = 'actions';

                            if (proc.status === 'running') {
                                const pBtn = document.createElement('button');
                                pBtn.textContent = 'Pausar';
                                pBtn.onclick = () => controlProcess(proc.id, 'pause');
                                actionsDiv.appendChild(pBtn);
                            }
                            if (proc.status === 'paused') {
                                const rBtn = document.createElement('button');
                                rBtn.textContent = 'Reanudar';
                                rBtn.onclick = () => controlProcess(proc.id, 'resume');
                                actionsDiv.appendChild(rBtn);
                            }
                            if (proc.status === 'running' || proc.status === 'paused' || proc.status === 'scheduled') {
                                const sBtn = document.createElement('button');
                                sBtn.textContent = 'Detener';
                                sBtn.onclick = () => { if(confirm('Seguro?')) controlProcess(proc.id, 'stop'); };
                                actionsDiv.appendChild(sBtn);
                            }
                            li.appendChild(detailsDiv);
                            li.appendChild(actionsDiv);
                            processesListUl.appendChild(li);
                        });
                     }
                     */


                } else {
                    processesListUl.innerHTML = `<li>Error: ${result.error || 'No se pudo cargar la lista de procesos.'}</li>`;
                }
            } catch (error) {
                console.error('Error fetching processes list:', error);
                processesListUl.innerHTML = '<li>Error de red al cargar la lista de procesos.</li>';
            }
        }
        refreshProcessesListButton.addEventListener('click', fetchProcesses);


        // Inicializar conexión WebSocket al cargar la página
        connectWebSocket();
        fetchOverallStatus(); // Cargar estado inicial
        fetchProcesses(); // Cargar lista de procesos inicial
    </script>
</body>
</html>