<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Bulk Sender PRO</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 25px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        .grid-item {
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background-color: #fdfdfd;
        }
        h1, h2, h3 {
            color: #2c3e50;
            margin-top: 0;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #1a73e8;
        }
        h2 {
            border-bottom: 2px solid #1a73e8;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        input[type="file"],
        input[type="text"],
        input[type="number"],
        input[type="datetime-local"],
        select,
        textarea {
            width: calc(100% - 22px);
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #1a73e8;
            outline: none;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        button {
            background-color: #1a73e8;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s, box-shadow 0.3s;
            margin-right: 10px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #1558b0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:disabled {
            background-color: #a0c3ff;
            cursor: not-allowed;
        }
        .qr-area, .status-area, .file-info, .process-info, .process-controls, .message-config {
            margin-bottom: 20px;
        }
        #qrCodeImg {
            max-width: 250px;
            height: auto;
            margin: 10px auto;
            display: block;
            border: 1px solid #eee;
            padding: 5px;
            border-radius: 4px;
        }
        #pairingCodeDisplay {
            font-weight: bold;
            color: #1a73e8;
            font-size: 1.2em;
            margin: 15px 0;
            text-align: center;
            letter-spacing: 1px;
            padding: 10px;
            border: 1px dashed #1a73e8;
            border-radius: 4px;
            background-color: #e9f5ff;
        }
        #connectionStatus, #progressText, #processStatusText, #overallStatusText {
            font-style: italic;
            color: #555;
            min-height: 1.2em;
        }
        #connectionStatus.connected { color: #27ae60; font-weight: bold; }
        #connectionStatus.disconnected { color: #c0392b; font-weight: bold; }

        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }
        .progress-bar {
            width: 0%;
            height: 25px;
            background-color: #27ae60;
            text-align: center;
            line-height: 25px;
            color: white;
            transition: width 0.4s ease;
        }
        #contactsPreview {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            background-color: #f9f9f9;
            font-size: 0.9em;
            border-radius: 4px;
        }
        #contactsPreview p { margin: 5px 0; }
        .error-message {
            color: #c0392b;
            background-color: #fdd;
            border: 1px solid #c0392b;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .success-message {
            color: #27ae60;
            background-color: #dfd;
            border: 1px solid #27ae60;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .info-message { /* Para el pairing code u otros mensajes informativos */
            color: #00529B;
            background-color: #BDE5F8;
            border: 1px solid #00529B;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ccc;
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1rem;
            margin-right: 5px;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active {
            border-bottom: 3px solid #1a73e8;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #processesList {
            list-style-type: none;
            padding: 0;
        }
        #processesList li {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
        }
        #processesList li .details {
             flex-grow: 1;
             margin-right: 10px;
             min-width: 200px;
        }
        #processesList li .details span { display: block; font-size: 0.9em; margin-bottom: 3px; }
        #processesList li .details strong { color: #333; }
        #processesList li .actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }
        #processesList li .actions button {
            font-size: 0.8em;
            padding: 6px 10px;
            margin-top: 0;
            margin-right: 0;
        }

        @media (max-width: 768px) {
            .grid-container {
                grid-template-columns: 1fr;
            }
            #processesList li {
                flex-direction: column;
                align-items: flex-start;
            }
            #processesList li .actions {
                margin-top: 10px;
                width: 100%;
                justify-content: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WhatsApp Bulk Sender PRO</h1>

        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'mainTab')">Envío Principal</button>
            <button class="tab-button" onclick="openTab(event, 'statusTab')">Estado del Sistema</button>
            <button class="tab-button" onclick="openTab(event, 'processesTab')">Gestión de Procesos</button>
        </div>

        <div id="mainTab" class="tab-content active">
            <div class="grid-container">
                <div class="grid-item qr-area">
                    <h2>Autenticación WhatsApp</h2>
                    <img id="qrCodeImg" src="" alt="Escanea el código QR" style="display: none;">
                    <p id="pairingCodeDisplay" style="display: none;"></p>
                    <p id="connectionStatus">Estado de conexión: Desconectado</p>
                    <button id="requestQRButton">Solicitar Autenticación</button>
                </div>

                <div class="grid-item file-upload-area">
                    <h2>1. Cargar Archivo Excel</h2>
                    <form id="uploadForm">
                        <label for="excelFile">Archivo Excel (.xlsx, .xls):</label>
                        <input type="file" id="excelFile" name="excel" accept=".xlsx, .xls" required>
                        <button type="submit" id="uploadButton">Procesar Archivo</button>
                    </form>
                    <div id="fileInfo" style="display: none;">
                        <h3>Información del Archivo:</h3>
                        <p>Filas Totales en Archivo: <span id="totalRowsInFile"></span></p>
                        <p>Filas Procesadas: <span id="processedRows"></span></p>
                        <p>Contactos Válidos: <span id="validContactsCount"></span></p>
                        <p>Números Totales en Contactos Válidos: <span id="totalNumbers"></span></p>
                        <h4>Contactos Cargados (para envío):</h4>
                        <div id="contactsPreview">Se mostrarán aquí los detalles si el archivo es pequeño, o un resumen.</div>
                    </div>
                </div>
            </div>

            <div class="grid-item message-config">
                <h2>2. Configurar Mensaje y Envío</h2>
                <form id="bulkSendForm">
                    <div>
                        <label for="messageTemplate">Plantilla del Mensaje (usa {nombre} para el primer nombre):</label>
                        <textarea id="messageTemplate" rows="5" placeholder="Ej: Hola {nombre}, te recordamos nuestra promoción..."></textarea>
                    </div>
                    <div>
                        <label for="delay">Retraso entre mensajes (milisegundos):</label>
                        <input type="number" id="delay" value="3000" min="1000" max="300000">
                    </div>
                    <div>
                        <label for="mediaUrl">URL del Archivo Multimedia (Opcional):</label>
                        <input type="text" id="mediaUrl" placeholder="https://ejemplo.com/imagen.jpg">
                    </div>
                    <div>
                        <label for="mediaType">Tipo de Multimedia (si URL está presente):</label>
                        <select id="mediaType">
                            <option value="">Ninguno</option>
                            <option value="image">Imagen</option>
                            <option value="video">Video</option>
                            <option value="document">Documento</option>
                            <option value="audio">Audio</option>
                        </select>
                    </div>
                    <div>
                        <label for="scheduledTime">Programar Envío (Opcional):</label>
                        <input type="datetime-local" id="scheduledTime">
                    </div>
                    <button type="submit" id="startBulkSendButton" disabled>Iniciar Envío Masivo</button>
                </form>
            </div>

            <div class="grid-item process-info">
                <h2>Progreso del Envío Actual (Principal)</h2>
                <p>ID del Proceso: <span id="currentProcessId">-</span></p>
                <p id="processStatusText">Estado: Esperando inicio</p>
                <div class="progress-container">
                    <div id="progressBar" class="progress-bar">0%</div>
                </div>
                <p id="progressText">Enviados: 0/0 | Exitosos: 0 | Fallidos: 0</p>
                <div class="process-controls">
                    <button id="pauseButton" disabled>Pausar</button>
                    <button id="resumeButton" disabled>Reanudar</button>
                    <button id="stopButton" disabled>Detener</button>
                </div>
            </div>
        </div>

        <div id="statusTab" class="tab-content">
            <h2>Estado General del Sistema</h2>
            <button id="refreshOverallStatusButton">Actualizar Estado</button>
            <div id="overallStatusArea">
                <pre id="overallStatusText">Cargando estado...</pre>
            </div>
        </div>

        <div id="processesTab" class="tab-content">
            <h2>Gestión de Procesos de Envío</h2>
            <button id="refreshProcessesListButton">Actualizar Lista</button>
            <ul id="processesList">
                <!-- Los procesos se listarán aquí -->
            </ul>
            <div id="processesStats">
                <!-- Las estadísticas de procesos se mostrarán aquí -->
            </div>
        </div>

        <div id="messageArea" style="margin-top: 20px;"></div>

    </div>

    <script>
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsURL = `${wsProtocol}//${window.location.host}`;
        let ws = null;

        let a_excelContacts = [];
        let a_currentProcessId = null;

        const qrCodeImg = document.getElementById('qrCodeImg');
        const pairingCodeDisplayP = document.getElementById('pairingCodeDisplay');
        const connectionStatusP = document.getElementById('connectionStatus');
        const requestQRButton = document.getElementById('requestQRButton');

        const uploadForm = document.getElementById('uploadForm');
        const excelFile = document.getElementById('excelFile');
        const uploadButton = document.getElementById('uploadButton');
        const fileInfoDiv = document.getElementById('fileInfo');

        const totalRowsInFileSpan = document.getElementById('totalRowsInFile');
        const processedRowsSpan = document.getElementById('processedRows');
        const validContactsCountSpan = document.getElementById('validContactsCount');
        const totalNumbersSpan = document.getElementById('totalNumbers');
        const contactsPreviewDiv = document.getElementById('contactsPreview');

        const bulkSendForm = document.getElementById('bulkSendForm');
        const messageTemplateTextarea = document.getElementById('messageTemplate');
        const delayInput = document.getElementById('delay');
        const mediaUrlInput = document.getElementById('mediaUrl');
        const mediaTypeSelect = document.getElementById('mediaType');
        const scheduledTimeInput = document.getElementById('scheduledTime');
        const startBulkSendButton = document.getElementById('startBulkSendButton');

        const currentProcessIdSpan = document.getElementById('currentProcessId');
        const processStatusTextP = document.getElementById('processStatusText');
        const progressBar = document.getElementById('progressBar');
        const progressTextP = document.getElementById('progressText');
        const pauseButton = document.getElementById('pauseButton');
        const resumeButton = document.getElementById('resumeButton');
        const stopButton = document.getElementById('stopButton');

        const messageArea = document.getElementById('messageArea');

        const overallStatusArea = document.getElementById('overallStatusArea');
        const overallStatusText = document.getElementById('overallStatusText');
        const refreshOverallStatusButton = document.getElementById('refreshOverallStatusButton');

        const processesListUl = document.getElementById('processesList');
        const processesStatsDiv = document.getElementById('processesStats');
        const refreshProcessesListButton = document.getElementById('refreshProcessesListButton');

        function showMessage(text, type = 'info', duration = 7000) { // Aumentar duración por defecto
            const div = document.createElement('div');
            div.textContent = text;
            div.className = type === 'error' ? 'error-message' : (type === 'success' ? 'success-message' : 'info-message');
            messageArea.innerHTML = ''; // Limpiar mensajes anteriores para evitar acumulación
            messageArea.appendChild(div);

            if(duration > 0) {
                setTimeout(() => {
                    if (messageArea.contains(div)) {
                         messageArea.removeChild(div);
                    }
                }, duration);
            }
        }

        function connectWebSocket() {
            if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
                return;
            }
            ws = new WebSocket(wsURL);

            ws.onopen = () => {
                console.log('WebSocket conectado.');
                connectionStatusP.textContent = 'Conectado al servidor. Verificando estado WhatsApp...';
                ws.send(JSON.stringify({ type: 'get_status' }));
                fetchProcesses();
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    console.log('MSG Server:', message);

                    switch (message.type) {
                        case 'qr_update': // Se usa si usePairingCode = false
                            pairingCodeDisplayP.style.display = 'none';
                            pairingCodeDisplayP.textContent = '';
                            qrCodeImg.src = message.data || '';
                            qrCodeImg.style.display = message.data ? 'block' : 'none';
                            if (message.data) {
                                connectionStatusP.textContent = 'Estado: Escanee el QR con WhatsApp.';
                                connectionStatusP.className = 'disconnected';
                            } else {
                                connectionStatusP.textContent = 'QR no disponible. Intentando conectar...';
                                connectionStatusP.className = 'disconnected';
                            }
                            break;

                        case 'pairing_code': // Se usa si usePairingCode = true
                            qrCodeImg.style.display = 'none';
                            qrCodeImg.src = '';
                            const pairingMsg = `Código de Emparejamiento: ${message.data}`;
                            pairingCodeDisplayP.textContent = pairingMsg + ". Ingréselo en WhatsApp > Dispositivos Vinculados > Vincular con número de teléfono.";
                            pairingCodeDisplayP.style.display = 'block';
                            connectionStatusP.textContent = 'Estado: Esperando vinculación con código.';
                            connectionStatusP.className = 'disconnected';
                            showMessage(pairingMsg, 'info', 20000);
                            break;

                        case 'status_update':
                            if (message.data.connected) {
                                connectionStatusP.textContent = `Estado: Conectado como ${message.data.user?.name || message.data.user?.id || 'Usuario'}.`;
                                connectionStatusP.className = 'connected';
                                qrCodeImg.style.display = 'none';
                                pairingCodeDisplayP.style.display = 'none';
                                pairingCodeDisplayP.textContent = '';
                                if (a_excelContacts.length > 0) startBulkSendButton.disabled = false;
                            } else {
                                connectionStatusP.textContent = `Estado: Desconectado. ${message.data.error || 'Intentando obtener método de autenticación...'}`;
                                connectionStatusP.className = 'disconnected';
                                startBulkSendButton.disabled = true;
                                // El servidor debería enviar 'qr_update' o 'pairing_code' si no está conectado.
                                // El botón 'requestQRButton' puede forzar una nueva solicitud.
                                ws.send(JSON.stringify({ type: 'request_qr' })); // Solicitar QR/código al recibir desconexión
                            }
                            break;
                        case 'process_update':
                            updateProcessUI(message.data);
                            if (document.getElementById('processesTab').classList.contains('active')) {
                                fetchProcesses();
                            }
                            break;
                        default:
                            console.log("Tipo de mensaje WS no manejado:", message.type);
                    }
                } catch (error) {
                    console.error('Error procesando mensaje WS:', error, event.data);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket Error:', error);
                connectionStatusP.textContent = 'Error de conexión WebSocket.';
                connectionStatusP.className = 'disconnected';
                disableAllControls();
            };

            ws.onclose = (event) => {
                console.log('WebSocket desconectado:', event.code, event.reason);
                connectionStatusP.textContent = `Servidor Desconectado (${event.code}). Reintentando...`;
                connectionStatusP.className = 'disconnected';
                disableAllControls();
                setTimeout(connectWebSocket, 5000);
            };
        }

        function disableAllControls() {
            startBulkSendButton.disabled = true;
            pauseButton.disabled = true;
            resumeButton.disabled = true;
            stopButton.disabled = true;
        }

        requestQRButton.addEventListener('click', () => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                showMessage('Solicitando estado de autenticación...', 'info');
                ws.send(JSON.stringify({ type: 'request_qr' })); // Este mensaje en el server ahora maneja QR o Pairing Code
            } else {
                showMessage('WebSocket no conectado. Intentando reconectar...', 'error');
                connectWebSocket();
            }
        });

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!excelFile.files.length) {
                showMessage('Por favor, selecciona un archivo Excel.', 'error');
                return;
            }
            const formData = new FormData();
            formData.append('excel', excelFile.files[0]);
            uploadButton.disabled = true;
            uploadButton.textContent = 'Procesando...';
            startBulkSendButton.disabled = true;

            try {
                const response = await fetch('/api/upload-excel', { method: 'POST', body: formData });
                const result = await response.json();
                if (result.success && result.data) {
                    showMessage('Archivo procesado exitosamente.', 'success');
                    fileInfoDiv.style.display = 'block';
                    totalRowsInFileSpan.textContent = result.data.totalRowsInFile;
                    processedRowsSpan.textContent = result.data.processedRows;
                    validContactsCountSpan.textContent = result.data.validContacts;
                    totalNumbersSpan.textContent = result.data.summary.totalNumbersFound;
                    a_excelContacts = result.data.contacts;
                    contactsPreviewDiv.innerHTML = '';
                    if (a_excelContacts.length > 0) {
                        const previewCount = Math.min(5, a_excelContacts.length);
                        for(let i=0; i < previewCount; i++) {
                            const contact = a_excelContacts[i];
                            const p = document.createElement('p');
                            p.textContent = `Nombre: ${contact.name}, Números: ${contact.numbers.join(', ')}, Fila Excel: ${contact.rowIndex}`;
                            contactsPreviewDiv.appendChild(p);
                        }
                        if(a_excelContacts.length > previewCount) {
                            contactsPreviewDiv.appendChild(document.createTextNode(`... y ${a_excelContacts.length - previewCount} más contactos.`));
                        }
                        if (connectionStatusP.className === 'connected') startBulkSendButton.disabled = false;
                    } else {
                        contactsPreviewDiv.textContent = 'No se encontraron contactos válidos.';
                        showMessage('No se encontraron contactos válidos.', 'error');
                    }
                } else {
                    showMessage(result.error || 'Error al procesar el archivo.', 'error');
                    fileInfoDiv.style.display = 'none'; a_excelContacts = [];
                }
            } catch (error) {
                console.error('Error subiendo archivo:', error);
                showMessage('Error de red al subir el archivo.', 'error');
                fileInfoDiv.style.display = 'none'; a_excelContacts = [];
            } finally {
                uploadButton.disabled = false;
                uploadButton.textContent = 'Procesar Archivo';
            }
        });

        bulkSendForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (a_excelContacts.length === 0) { showMessage('No hay contactos cargados.', 'error'); return; }
            if (!messageTemplateTextarea.value.trim()) { showMessage('El mensaje no puede estar vacío.', 'error'); return; }
            if (connectionStatusP.className !== 'connected') { showMessage('WhatsApp no está conectado.', 'error'); return; }

            const payload = {
                contacts: a_excelContacts,
                messageTemplate: messageTemplateTextarea.value,
                delay: parseInt(delayInput.value, 10) || 3000,
                mediaUrl: mediaUrlInput.value.trim() || undefined,
                mediaType: mediaUrlInput.value.trim() ? mediaTypeSelect.value : undefined,
                scheduledTime: scheduledTimeInput.value || undefined
            };
            if (payload.scheduledTime && new Date(payload.scheduledTime) <= new Date()) {
                showMessage('La fecha de programación debe ser en el futuro.', 'error'); return;
            }
            startBulkSendButton.disabled = true; startBulkSendButton.textContent = 'Iniciando...';
            try {
                const response = await fetch('/api/bulk-send', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.success) {
                    showMessage(result.message || `Proceso ${result.processId} iniciado/programado.`, 'success');
                    a_currentProcessId = result.processId;
                    currentProcessIdSpan.textContent = a_currentProcessId;
                } else {
                    showMessage(result.error || 'Error al iniciar el envío.', 'error');
                    startBulkSendButton.disabled = (a_excelContacts.length === 0 || connectionStatusP.className !== 'connected');
                    startBulkSendButton.textContent = 'Iniciar Envío Masivo';
                }
            } catch (error) {
                console.error('Error iniciando envío masivo:', error);
                showMessage('Error de red al iniciar el envío.', 'error');
                startBulkSendButton.disabled = (a_excelContacts.length === 0 || connectionStatusP.className !== 'connected');
                startBulkSendButton.textContent = 'Iniciar Envío Masivo';
            }
        });

        function updateProcessUI(processData) {
            if (processData && (a_currentProcessId === processData.id || (!a_currentProcessId && ['running', 'scheduled', 'pending'].includes(processData.status)))) {
                if (!a_currentProcessId) a_currentProcessId = processData.id;
                currentProcessIdSpan.textContent = processData.id;
                let statusText = `Estado: ${processData.status}`;
                if (processData.scheduledTime && (processData.status === 'scheduled' || processData.status === 'pending')) {
                     statusText += ` (Para: ${new Date(processData.scheduledTime).toLocaleString()})`;
                }
                processStatusTextP.textContent = statusText;
                const progress = processData.progress || 0;
                progressBar.style.width = `${progress}%`; progressBar.textContent = `${progress}%`;
                progressTextP.textContent = `Progreso: ${processData.currentIndex || 0}/${processData.totalCount || 0} | Éxito: ${processData.successCount || 0} | Fallo: ${processData.failureCount || 0}`;
                updateProcessSpecificControls(processData.status);
            }
        }

        function updateProcessSpecificControls(status) {
            startBulkSendButton.textContent = 'Iniciar Envío Masivo';
            const isProcessActiveOnMainUI = (a_currentProcessId && document.getElementById('currentProcessId').textContent === a_currentProcessId);

            pauseButton.disabled = !(status === 'running' && isProcessActiveOnMainUI);
            resumeButton.disabled = !(status === 'paused' && isProcessActiveOnMainUI);
            stopButton.disabled = !(['running', 'paused', 'scheduled', 'pending'].includes(status) && isProcessActiveOnMainUI);
            startBulkSendButton.disabled = (status === 'running' || status === 'paused' || status === 'scheduled' || a_excelContacts.length === 0 || connectionStatusP.className !== 'connected');

            if (['completed', 'failed', 'stopped'].includes(status) && isProcessActiveOnMainUI) {
                a_currentProcessId = null;
                currentProcessIdSpan.textContent = '-';
                processStatusTextP.textContent = 'Estado: Esperando inicio';
                progressBar.style.width = '0%'; progressBar.textContent = '0%';
                progressTextP.textContent = 'Enviados: 0/0 | Exitosos: 0 | Fallidos: 0';
                startBulkSendButton.disabled = (a_excelContacts.length === 0 || connectionStatusP.className !== 'connected');
            }
        }

        async function controlProcess(id, action) {
            if (!id) { showMessage('No hay ID de proceso para controlar.', 'error'); return; }
            const targetButton = action === 'pause' ? pauseButton : (action === 'resume' ? resumeButton : stopButton);
            targetButton.disabled = true; // Deshabilitar botón específico temporalmente
            try {
                const response = await fetch(`/api/process/${id}/${action}`, { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    showMessage(`Acción '${action}' para proceso ${id} exitosa. Nuevo estado: ${result.processStatus || 'actualizando...'}`, 'success');
                    if (id === a_currentProcessId && result.processStatus) {
                        updateProcessSpecificControls(result.processStatus); // Actualiza controles de la UI principal
                    }
                    fetchProcesses(); // Refrescar siempre la lista de procesos
                } else {
                    showMessage(`Error al '${action}' proceso ${id}: ${result.error || 'Error desconocido'}`, 'error');
                    targetButton.disabled = false; // Rehabilitar si falla
                }
            } catch (error) {
                console.error(`Error en ${action} proceso:`, error);
                showMessage(`Error de red al '${action}' el proceso.`, 'error');
                targetButton.disabled = false; // Rehabilitar en error de red
            }
        }

        pauseButton.addEventListener('click', () => controlProcess(a_currentProcessId, 'pause'));
        resumeButton.addEventListener('click', () => controlProcess(a_currentProcessId, 'resume'));
        stopButton.addEventListener('click', () => {
            if (a_currentProcessId && confirm(`¿Estás seguro de que quieres detener el proceso ${a_currentProcessId}?`)) {
                controlProcess(a_currentProcessId, 'stop');
            } else if (!a_currentProcessId) {
                showMessage('No hay proceso activo en la UI principal para detener.', 'error');
            }
        });

        function openTab(evt, tabName) {
            Array.from(document.getElementsByClassName("tab-content")).forEach(tc => tc.style.display = "none");
            Array.from(document.getElementsByClassName("tab-button")).forEach(tb => tb.className = tb.className.replace(" active", ""));
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
            if (tabName === 'statusTab') fetchOverallStatus();
            if (tabName === 'processesTab') fetchProcesses();
        }

        async function fetchOverallStatus() {
            try {
                overallStatusText.textContent = 'Actualizando...';
                const response = await fetch('/api/status');
                const result = await response.json();
                overallStatusText.textContent = result.success ? JSON.stringify(result.data, null, 2) : `Error: ${result.error || 'No se pudo cargar.'}`;
            } catch (error) {
                console.error('Error fetching overall status:', error);
                overallStatusText.textContent = 'Error de red al cargar el estado.';
            }
        }
        refreshOverallStatusButton.addEventListener('click', fetchOverallStatus);

        async function fetchProcesses() {
            try {
                const response = await fetch('/api/processes');
                const result = await response.json();
                processesListUl.innerHTML = ''; processesStatsDiv.innerHTML = '';
                if (result.success && result.data) {
                    if (result.data.stats) {
                        const stats = result.data.stats;
                        let statsHTML = '<h4>Resumen de Procesos:</h4><p>';
                        ['total', 'pending', 'running', 'paused', 'scheduled', 'completed', 'failed', 'stopped'].forEach(key => {
                            statsHTML += `${key.charAt(0).toUpperCase() + key.slice(1)}: ${stats[key] || 0} | `;
                        });
                        processesStatsDiv.innerHTML = statsHTML.slice(0, -3) + '</p>'; // Remover último " | "
                    }
                    if (Array.isArray(result.data.list) && result.data.list.length > 0) {
                        result.data.list.forEach(proc => {
                            const li = document.createElement('li');
                            const detailsDiv = document.createElement('div'); detailsDiv.className = 'details';
                            let sch = proc.status === 'scheduled' && proc.scheduledTime ? `<span><strong>Programado:</strong> ${new Date(proc.scheduledTime).toLocaleString()}</span>` : '';
                            let tim = '';
                            if(proc.startedAt) tim += `<span><strong>Iniciado:</strong> ${new Date(proc.startedAt).toLocaleString()}</span>`;
                            if(proc.completedAt) tim += `<span><strong>Finalizado:</strong> ${new Date(proc.completedAt).toLocaleString()}</span>`;
                            detailsDiv.innerHTML = `<span><strong>ID:</strong> ${proc.id}</span>
                                <span><strong>Estado:</strong> <span class="status-${proc.status}">${proc.status}</span></span>${sch}
                                <span><strong>Progreso:</strong> ${proc.currentIndex||0}/${proc.totalCount||0} (${proc.progress||0}%)</span>
                                <span><strong>Éxito:</strong> ${proc.successCount||0} | <strong>Fallo:</strong> ${proc.failureCount||0} (Errores: ${proc.errorCount||0})</span>${tim}`;
                            const actionsDiv = document.createElement('div'); actionsDiv.className = 'actions';
                            if (proc.status === 'running') {
                                const pBtn = document.createElement('button'); pBtn.textContent = 'Pausar';
                                pBtn.onclick = () => controlProcess(proc.id, 'pause'); actionsDiv.appendChild(pBtn);
                            }
                            if (proc.status === 'paused') {
                                const rBtn = document.createElement('button'); rBtn.textContent = 'Reanudar';
                                rBtn.onclick = () => controlProcess(proc.id, 'resume'); actionsDiv.appendChild(rBtn);
                            }
                            if (['running', 'paused', 'scheduled', 'pending'].includes(proc.status)) {
                                const sBtn = document.createElement('button'); sBtn.textContent = 'Detener'; sBtn.style.backgroundColor = '#dc3545';
                                sBtn.onclick = () => { if(confirm(`Detener proceso ${proc.id}?`)) controlProcess(proc.id, 'stop'); };
                                actionsDiv.appendChild(sBtn);
                            }
                            li.appendChild(detailsDiv); li.appendChild(actionsDiv); processesListUl.appendChild(li);
                        });
                    } else { processesListUl.innerHTML = '<li>No hay procesos individuales para mostrar.</li>'; }
                } else { processesListUl.innerHTML = `<li>Error: ${result.error || 'No se pudo cargar la lista.'}</li>`; }
            } catch (error) {
                console.error('Error fetching processes list:', error);
                processesListUl.innerHTML = '<li>Error de red al cargar la lista.</li>';
            }
        }
        refreshProcessesListButton.addEventListener('click', fetchProcesses);

        connectWebSocket();
        if (document.getElementById('statusTab').classList.contains('active')) fetchOverallStatus();
        if (document.getElementById('processesTab').classList.contains('active')) fetchProcesses();
    </script>
</body>
</html>